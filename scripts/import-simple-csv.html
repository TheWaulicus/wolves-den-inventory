<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import Simple CSV - Wolves Den</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1000px;
      margin: 2rem auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    .status {
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
      border-left: 4px solid;
    }
    .success { background: #e8f5e9; border-color: #4caf50; }
    .error { background: #ffebee; border-color: #f44336; }
    .info { background: #e3f2fd; border-color: #2196f3; }
    button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }
    button:hover { background: #1976d2; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log {
      background: #263238;
      color: #aed581;
      padding: 1rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 1rem;
    }
    .log div { margin: 0.25rem 0; }
    .upload-area {
      border: 2px dashed #2196f3;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      margin: 2rem 0;
      cursor: pointer;
    }
    .upload-area:hover { background: #e3f2fd; }
    input[type="file"] { display: none; }
    .preview {
      margin: 1rem 0;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 1rem;
      border-radius: 4px;
    }
    .preview table {
      width: 100%;
      border-collapse: collapse;
    }
    .preview th, .preview td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .preview th { background: #f5f5f5; font-weight: 600; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üê∫ Import Inventory from Simple CSV</h1>
    <p>Upload CSV file with columns: Section, Category, Size, Quantity</p>

    <div class="status info" id="status">
      <strong>Status:</strong> Please sign in to import data
    </div>

    <div id="authSection" style="margin: 2rem 0; padding: 1.5rem; background: #f5f5f5; border-radius: 8px;">
      <h3>üîê Sign In</h3>
      <div style="display: flex; gap: 1rem; align-items: flex-end;">
        <div style="flex: 1;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Email</label>
          <input type="email" id="emailInput" placeholder="wolves@icezoo.com" 
                 style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="flex: 1;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Password</label>
          <input type="password" id="passwordInput" placeholder="Password"
                 style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <button onclick="signIn()" style="margin: 0;">Sign In</button>
      </div>
      <div id="authStatus" style="margin-top: 1rem; font-size: 14px;"></div>
    </div>

    <div id="uploadSection" style="display: none;">
      <div class="upload-area" id="uploadArea">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
        <h3>Drop CSV file here or click to browse</h3>
        <p>Format: Section, Category, Size, Quantity</p>
        <input type="file" id="fileInput" accept=".csv">
      </div>

      <div id="preview" class="preview" style="display: none;"></div>

      <div>
        <button id="importBtn" disabled onclick="importData()">Import to Firebase</button>
        <button onclick="clearLog()">Clear Log</button>
      </div>
    </div>

    <div class="log" id="log"></div>
  </div>

  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- Firebase Config -->
  <script src="../src/firebase-config.js"></script>

  <!-- Models -->
  <script src="../src/models/GearType.js"></script>
  <script src="../src/models/GearItem.js"></script>

  <script>
    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const importBtn = document.getElementById('importBtn');
    const previewDiv = document.getElementById('preview');

    let parsedData = [];

    function log(message, type = 'info') {
      const div = document.createElement('div');
      const timestamp = new Date().toLocaleTimeString();
      const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: 'üìã' };
      div.textContent = `[${timestamp}] ${icons[type] || 'üìã'} ${message}`;
      logDiv.appendChild(div);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function setStatus(message, type = 'info') {
      statusDiv.innerHTML = `<strong>Status:</strong> ${message}`;
      statusDiv.className = `status ${type}`;
    }

    function clearLog() {
      logDiv.innerHTML = '';
    }

    async function signIn() {
      const email = document.getElementById('emailInput').value;
      const password = document.getElementById('passwordInput').value;
      const authStatus = document.getElementById('authStatus');
      
      if (!email || !password) {
        authStatus.innerHTML = '‚ùå Please enter email and password';
        authStatus.style.color = '#f44336';
        return;
      }
      
      try {
        authStatus.innerHTML = '‚è≥ Signing in...';
        authStatus.style.color = '#2196f3';
        
        await firebase.auth().signInWithEmailAndPassword(email, password);
        
        log(`Signed in as: ${email}`, 'success');
        setStatus('Signed in! Ready to import.', 'success');
        
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('uploadSection').style.display = 'block';
        
      } catch (error) {
        log(`Sign in failed: ${error.message}`, 'error');
        authStatus.innerHTML = `‚ùå ${error.message}`;
        authStatus.style.color = '#f44336';
      }
    }

    // Upload area events
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.background = '#bbdefb';
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.background = '';
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.background = '';
      const files = e.dataTransfer.files;
      if (files.length > 0) handleFile(files[0]);
    });
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) handleFile(e.target.files[0]);
    });

    function handleFile(file) {
      if (!file.name.endsWith('.csv')) {
        setStatus('Please upload a CSV file', 'error');
        return;
      }

      log(`Loading file: ${file.name}`, 'info');
      setStatus('Reading CSV file...', 'info');

      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result;
        parseCSV(content);
      };
      reader.onerror = () => {
        setStatus('Error reading file', 'error');
        log('Failed to read file', 'error');
      };
      reader.readAsText(file);
    }

    function parseCSV(content) {
      try {
        log('Parsing CSV data...', 'info');
        
        const lines = content.split('\n');
        parsedData = [];
        
        // Skip header row
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const cells = line.split(',').map(c => c.trim());
          
          if (cells.length >= 4) {
            const section = cells[0];
            const category = cells[1];
            const size = cells[2];
            const quantity = parseInt(cells[3]);
            
            if (section && category && quantity > 0) {
              parsedData.push({
                section: section,
                category: category,
                size: size || 'One Size',
                quantity: quantity
              });
            }
          }
        }
        
        log(`Parsed ${parsedData.length} items from CSV`, 'success');
        setStatus(`Found ${parsedData.length} inventory items`, 'success');
        
        showPreview();
        importBtn.disabled = false;
        
      } catch (error) {
        log(`Parse error: ${error.message}`, 'error');
        setStatus('Error parsing CSV', 'error');
        console.error(error);
      }
    }

    function showPreview() {
      const grouped = {};
      parsedData.forEach(item => {
        const key = `${item.section} - ${item.category}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(item);
      });
      
      let html = '<h3>Preview</h3><table><thead><tr><th>Section - Category</th><th>Items</th><th>Total</th></tr></thead><tbody>';
      
      Object.entries(grouped).forEach(([key, items]) => {
        const total = items.reduce((sum, item) => sum + item.quantity, 0);
        const sizes = items.map(i => `${i.size} (${i.quantity})`).join(', ');
        html += `<tr><td><strong>${key}</strong></td><td>${sizes}</td><td>${total}</td></tr>`;
      });
      
      html += '</tbody></table>';
      previewDiv.innerHTML = html;
      previewDiv.style.display = 'block';
    }

    async function importData() {
      if (parsedData.length === 0) {
        setStatus('No data to import', 'error');
        return;
      }

      if (!confirm(`Import ${parsedData.length} items to Firebase?`)) return;

      importBtn.disabled = true;
      setStatus('Importing data to Firebase...', 'info');
      log('Starting import...', 'info');

      try {
        // Create gear types
        const gearTypes = new Set();
        parsedData.forEach(item => gearTypes.add(item.category));

        log(`Creating/verifying ${gearTypes.size} gear types...`, 'info');
        
        for (const typeName of gearTypes) {
          const existing = await db.collection('gearTypes')
            .where('name', '==', typeName)
            .limit(1)
            .get();
          
          if (existing.empty) {
            const gearType = new GearType({
              name: typeName,
              category: 'equipment',
              requiresSize: true,
              commonSizes: []
            });
            await db.collection('gearTypes').add(gearType.toFirestore());
            log(`Created gear type: ${typeName}`, 'success');
          }
        }

        // Import gear items
        let imported = 0;
        
        for (const item of parsedData) {
          const gearItem = new GearItem({
            gearType: item.category,
            brand: 'Stock',
            model: item.section,
            size: item.size,
            condition: 'good',
            status: 'available',
            location: 'The Shed',
            notes: `${item.section} ${item.category} - Size ${item.size}`,
            barcode: '',
            photoURLs: []
          });

          await db.collection('gearItems').add(gearItem.toFirestore());
          imported++;

          if (imported % 10 === 0) {
            log(`Imported ${imported}/${parsedData.length} items...`, 'info');
          }
        }

        log(`Successfully imported ${imported} items!`, 'success');
        setStatus(`Import complete! ${imported} items added to Firebase`, 'success');
        
      } catch (error) {
        log(`Import error: ${error.message}`, 'error');
        setStatus('Import failed', 'error');
        console.error(error);
        importBtn.disabled = false;
      }
    }

    // Check auth state
    window.addEventListener('load', () => {
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          log(`Already signed in as: ${user.email}`, 'success');
          setStatus('Already signed in! Ready to import.', 'success');
          document.getElementById('authSection').style.display = 'none';
          document.getElementById('uploadSection').style.display = 'block';
        }
      });
    });
  </script>
</body>
</html>
