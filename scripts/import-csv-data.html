<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import CSV Stock Data - Wolves Den</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1000px;
      margin: 2rem auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    .upload-area {
      border: 2px dashed #2196f3;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      margin: 2rem 0;
      cursor: pointer;
      transition: all 0.3s;
    }
    .upload-area:hover { background: #e3f2fd; }
    .upload-area.dragover { background: #bbdefb; border-color: #1976d2; }
    .status {
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
      border-left: 4px solid;
    }
    .success { background: #e8f5e9; border-color: #4caf50; }
    .error { background: #ffebee; border-color: #f44336; }
    .warning { background: #fff3e0; border-color: #ff9800; }
    .info { background: #e3f2fd; border-color: #2196f3; }
    button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }
    button:hover { background: #1976d2; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log {
      background: #263238;
      color: #aed581;
      padding: 1rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 1rem;
    }
    .log div { margin: 0.25rem 0; }
    .preview {
      margin: 1rem 0;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 1rem;
      border-radius: 4px;
    }
    .preview table {
      width: 100%;
      border-collapse: collapse;
    }
    .preview th, .preview td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .preview th { background: #f5f5f5; font-weight: 600; }
    input[type="file"] { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üê∫ Import Stock Data from CSV</h1>
    <p>Upload "The Shed - Stock.csv" to import your real inventory data</p>

    <div class="status info" id="status">
      <strong>Status:</strong> Please sign in first.
    </div>

    <div id="authSection" style="margin: 2rem 0; padding: 1.5rem; background: #f5f5f5; border-radius: 8px;">
      <h3>üîê Sign In to Import Data</h3>
      <div style="display: flex; gap: 1rem; align-items: flex-end;">
        <div style="flex: 1;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Email</label>
          <input type="email" id="emailInput" placeholder="admin@wolves.com" 
                 style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="flex: 1;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Password</label>
          <input type="password" id="passwordInput" placeholder="Password"
                 style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <button onclick="signIn()" style="margin: 0;">Sign In</button>
      </div>
      <div id="authStatus" style="margin-top: 1rem; font-size: 14px;"></div>
    </div>

    <div class="upload-area" id="uploadArea" style="display: none;">
      <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
      <h3>Drop CSV file here or click to browse</h3>
      <p>Supported: The Shed - Stock.csv</p>
      <input type="file" id="fileInput" accept=".csv">
    </div>

    <div id="preview" class="preview" style="display: none;"></div>

    <div>
      <button id="importBtn" disabled onclick="importData()">Import to Firebase</button>
      <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="log" id="log"></div>
  </div>

  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- Firebase Config -->
  <script src="../src/firebase-config.js"></script>

  <!-- Models -->
  <script src="../src/models/GearType.js"></script>
  <script src="../src/models/GearItem.js"></script>

  <script>
    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const importBtn = document.getElementById('importBtn');
    const previewDiv = document.getElementById('preview');

    let parsedData = [];

    function log(message, type = 'info') {
      const div = document.createElement('div');
      const timestamp = new Date().toLocaleTimeString();
      const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: 'üìã' };
      div.textContent = `[${timestamp}] ${icons[type] || 'üìã'} ${message}`;
      logDiv.appendChild(div);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function setStatus(message, type = 'info') {
      statusDiv.innerHTML = `<strong>Status:</strong> ${message}`;
      statusDiv.className = `status ${type}`;
    }

    function clearLog() {
      logDiv.innerHTML = '';
    }

    // Upload area events
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) handleFile(files[0]);
    });
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) handleFile(e.target.files[0]);
    });

    function handleFile(file) {
      if (!file.name.endsWith('.csv')) {
        setStatus('Please upload a CSV file', 'error');
        return;
      }

      log(`Loading file: ${file.name}`, 'info');
      setStatus('Reading CSV file...', 'info');

      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result;
        parseCSV(content);
      };
      reader.onerror = () => {
        setStatus('Error reading file', 'error');
        log('Failed to read file', 'error');
      };
      reader.readAsText(file);
    }

    function parseCSV(content) {
      try {
        log('Parsing CSV data...', 'info');
        
        const lines = content.split('\n');
        parsedData = [];
        
        let currentSection = ''; // Junior, Senior, Goalie
        let categoryCol0 = '';
        let categoryCol2 = '';
        let categoryCol5 = '';
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line || line === ',,,,,,,') continue;
          
          const cells = line.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
          
          // Detect section headers
          if (cells[0] && cells[0].includes('Junior Gear')) {
            currentSection = 'Junior';
            categoryCol0 = categoryCol2 = categoryCol5 = '';
            continue;
          } else if (cells[0] && cells[0].includes('Senior Gear')) {
            currentSection = 'Senior';
            categoryCol0 = categoryCol2 = categoryCol5 = '';
            continue;
          } else if (cells[0] && cells[0].includes('Goalie Gear')) {
            currentSection = 'Goalie';
            categoryCol0 = categoryCol2 = categoryCol5 = '';
            continue;
          }
          
          // Column 0-1: First column group
          if (cells[0]) {
            const qty = parseInt(cells[1]);
            if (isNaN(qty) || qty === 0) {
              // It's a category header
              if (cells[0]) categoryCol0 = cells[0];
            } else if (qty > 0 && categoryCol0) {
              // It's an item
              parsedData.push({
                section: currentSection,
                category: categoryCol0,
                size: cells[0],
                quantity: qty
              });
            }
          }
          
          // Column 2-4: Second column group
          if (cells[2]) {
            // Check if column 2 is a category header
            if (!cells[3] || isNaN(parseInt(cells[4])) || parseInt(cells[4]) === 0) {
              categoryCol2 = cells[2];
            }
          }
          
          if (cells[3]) {
            const qty = parseInt(cells[4]);
            if (!isNaN(qty) && qty > 0 && categoryCol2) {
              parsedData.push({
                section: currentSection,
                category: categoryCol2,
                size: cells[3],
                quantity: qty
              });
            }
          }
          
          // Column 5-7: Third column group
          if (cells[5]) {
            // Check if column 5 is a category header
            if (!cells[6] || isNaN(parseInt(cells[7])) || parseInt(cells[7]) === 0) {
              categoryCol5 = cells[5];
            }
          }
          
          if (cells[6]) {
            const qty = parseInt(cells[7]);
            if (!isNaN(qty) && qty > 0 && categoryCol5) {
              parsedData.push({
                section: currentSection,
                category: categoryCol5,
                size: cells[6],
                quantity: qty
              });
            }
          }
        }
        
        log(`Parsed ${parsedData.length} items from CSV`, 'success');
        setStatus(`Found ${parsedData.length} inventory items`, 'success');
        
        showPreview();
        importBtn.disabled = false;
        
      } catch (error) {
        log(`Parse error: ${error.message}`, 'error');
        setStatus('Error parsing CSV', 'error');
        console.error(error);
      }
    }

    function showPreview() {
      const grouped = {};
      parsedData.forEach(item => {
        const key = `${item.section} - ${item.category}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(item);
      });
      
      let html = '<h3>Preview (grouped by type)</h3><table><thead><tr><th>Category</th><th>Items</th><th>Total Qty</th></tr></thead><tbody>';
      
      Object.entries(grouped).forEach(([key, items]) => {
        const total = items.reduce((sum, item) => sum + item.quantity, 0);
        const sizes = items.map(i => `${i.size} (${i.quantity})`).join(', ');
        html += `<tr><td><strong>${key}</strong></td><td>${sizes}</td><td>${total}</td></tr>`;
      });
      
      html += '</tbody></table>';
      previewDiv.innerHTML = html;
      previewDiv.style.display = 'block';
    }

    async function importData() {
      if (parsedData.length === 0) {
        setStatus('No data to import', 'error');
        return;
      }

      if (!confirm(`Import ${parsedData.length} items to Firebase?`)) return;

      importBtn.disabled = true;
      setStatus('Importing data to Firebase...', 'info');
      log('Starting import...', 'info');

      try {
        // First, ensure gear types exist
        const gearTypes = new Set();
        parsedData.forEach(item => {
          gearTypes.add(item.category);
        });

        log(`Creating ${gearTypes.size} gear types...`, 'info');
        
        for (const typeName of gearTypes) {
          const existing = await db.collection('gearTypes')
            .where('name', '==', typeName)
            .limit(1)
            .get();
          
          if (existing.empty) {
            const gearType = new GearType({
              name: typeName,
              category: 'equipment',
              requiresSize: true,
              commonSizes: []
            });
            await db.collection('gearTypes').add(gearType.toFirestore());
            log(`Created gear type: ${typeName}`, 'success');
          }
        }

        // Now import gear items
        let imported = 0;
        const batch = db.batch();
        
        for (const item of parsedData) {
          const gearItem = new GearItem({
            gearType: item.category,
            brand: 'Stock',
            model: item.section,
            size: item.size,
            condition: 'good',
            status: 'available',
            location: 'The Shed',
            notes: `Imported from stock CSV - ${item.section} ${item.category}`,
            barcode: '',
            photoURLs: []
          });

          const ref = db.collection('gearItems').doc();
          batch.set(ref, gearItem.toFirestore());
          imported++;

          if (imported % 10 === 0) {
            log(`Processed ${imported}/${parsedData.length} items...`, 'info');
          }
        }

        await batch.commit();
        log(`Successfully imported ${imported} items!`, 'success');
        setStatus(`Import complete! ${imported} items added to Firebase`, 'success');
        
      } catch (error) {
        log(`Import error: ${error.message}`, 'error');
        setStatus('Import failed', 'error');
        console.error(error);
        importBtn.disabled = false;
      }
    }

    async function signIn() {
      const email = document.getElementById('emailInput').value;
      const password = document.getElementById('passwordInput').value;
      const authStatus = document.getElementById('authStatus');
      
      if (!email || !password) {
        authStatus.innerHTML = '‚ùå Please enter email and password';
        authStatus.style.color = '#f44336';
        return;
      }
      
      try {
        authStatus.innerHTML = '‚è≥ Signing in...';
        authStatus.style.color = '#2196f3';
        
        await firebase.auth().signInWithEmailAndPassword(email, password);
        
        log(`Signed in as: ${email}`, 'success');
        setStatus('Signed in successfully! Ready to import.', 'success');
        
        // Hide auth section, show upload area
        document.getElementById('authSection').style.display = 'none';
        uploadArea.style.display = 'block';
        
        authStatus.innerHTML = '‚úÖ Signed in successfully!';
        authStatus.style.color = '#4caf50';
        
      } catch (error) {
        log(`Sign in failed: ${error.message}`, 'error');
        authStatus.innerHTML = `‚ùå Sign in failed: ${error.message}`;
        authStatus.style.color = '#f44336';
      }
    }

    // Check Firebase connection and auth state
    window.addEventListener('load', async () => {
      try {
        log('Connecting to Firebase...', 'info');
        
        // Check auth state
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            log(`Already signed in as: ${user.email}`, 'success');
            setStatus('Already signed in! Ready to import.', 'success');
            document.getElementById('authSection').style.display = 'none';
            uploadArea.style.display = 'block';
          } else {
            log('Not signed in. Please sign in to import data.', 'warning');
          }
        });
        
      } catch (error) {
        log(`Failed to connect to Firebase: ${error.message}`, 'error');
        setStatus('Not connected to Firebase', 'error');
      }
    });
  </script>
</body>
</html>
