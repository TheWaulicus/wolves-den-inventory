<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cleanup Gear Types - Wolves Den</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1000px;
      margin: 2rem auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    .status {
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
      border-left: 4px solid;
    }
    .success { background: #e8f5e9; border-color: #4caf50; }
    .error { background: #ffebee; border-color: #f44336; }
    .warning { background: #fff3e0; border-color: #ff9800; }
    .info { background: #e3f2fd; border-color: #2196f3; }
    button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }
    button:hover { background: #1976d2; }
    button.danger { background: #f44336; }
    button.danger:hover { background: #d32f2f; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log {
      background: #263238;
      color: #aed581;
      padding: 1rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 1rem;
    }
    .log div { margin: 0.25rem 0; }
    .type-list {
      margin: 1rem 0;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
    }
    .type-item {
      padding: 0.5rem;
      margin: 0.5rem 0;
      background: #f5f5f5;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .type-item.unused {
      background: #ffebee;
      border-left: 3px solid #f44336;
    }
    .type-item.used {
      background: #e8f5e9;
      border-left: 3px solid #4caf50;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üßπ Cleanup Unused Gear Types</h1>
    <p>Remove gear types that have no associated items</p>

    <div class="status info" id="status">
      <strong>Status:</strong> Loading...
    </div>

    <div id="typesContainer" class="type-list"></div>

    <div>
      <button onclick="analyzeTypes()">üîç Analyze Gear Types</button>
      <button class="danger" id="deleteBtn" onclick="deleteUnused()" disabled>
        üóëÔ∏è Delete Unused Types
      </button>
      <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="log" id="log"></div>
  </div>

  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- Firebase Config -->
  <script src="../src/firebase-config.js"></script>

  <script>
    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');
    const typesContainer = document.getElementById('typesContainer');
    const deleteBtn = document.getElementById('deleteBtn');

    let unusedTypes = [];

    function log(message, type = 'info') {
      const div = document.createElement('div');
      const timestamp = new Date().toLocaleTimeString();
      const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: 'üìã' };
      div.textContent = `[${timestamp}] ${icons[type] || 'üìã'} ${message}`;
      logDiv.appendChild(div);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function setStatus(message, type = 'info') {
      statusDiv.innerHTML = `<strong>Status:</strong> ${message}`;
      statusDiv.className = `status ${type}`;
    }

    function clearLog() {
      logDiv.innerHTML = '';
    }

    async function analyzeTypes() {
      try {
        log('Analyzing gear types...', 'info');
        setStatus('Loading gear types and items...', 'info');

        // Get all gear types
        const typesSnapshot = await db.collection('gearTypes').get();
        const gearTypes = typesSnapshot.docs.map(doc => ({
          id: doc.id,
          name: doc.data().name
        }));

        log(`Found ${gearTypes.length} gear types`, 'info');

        // Check each type for usage
        const typeUsage = [];
        
        for (const type of gearTypes) {
          const itemsSnapshot = await db.collection('gearItems')
            .where('gearType', '==', type.name)
            .limit(1)
            .get();
          
          const isUsed = !itemsSnapshot.empty;
          
          typeUsage.push({
            id: type.id,
            name: type.name,
            isUsed: isUsed
          });

          log(`${type.name}: ${isUsed ? 'IN USE' : 'UNUSED'}`, isUsed ? 'success' : 'warning');
        }

        // Display results
        displayResults(typeUsage);

        unusedTypes = typeUsage.filter(t => !t.isUsed);
        
        if (unusedTypes.length > 0) {
          setStatus(`Found ${unusedTypes.length} unused gear types`, 'warning');
          deleteBtn.disabled = false;
        } else {
          setStatus('All gear types are in use!', 'success');
          deleteBtn.disabled = true;
        }

      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        setStatus('Analysis failed', 'error');
        console.error(error);
      }
    }

    function displayResults(typeUsage) {
      const used = typeUsage.filter(t => t.isUsed);
      const unused = typeUsage.filter(t => !t.isUsed);

      let html = `
        <h3>Gear Types Analysis</h3>
        <p><strong>Used:</strong> ${used.length} | <strong>Unused:</strong> ${unused.length}</p>
      `;

      if (used.length > 0) {
        html += '<h4 style="color: #4caf50;">‚úÖ Used Gear Types</h4>';
        used.forEach(type => {
          html += `<div class="type-item used">${type.name}</div>`;
        });
      }

      if (unused.length > 0) {
        html += '<h4 style="color: #f44336;">‚ö†Ô∏è Unused Gear Types (Will be deleted)</h4>';
        unused.forEach(type => {
          html += `<div class="type-item unused">${type.name}</div>`;
        });
      }

      typesContainer.innerHTML = html;
    }

    async function deleteUnused() {
      if (unusedTypes.length === 0) {
        setStatus('No unused types to delete', 'info');
        return;
      }

      const confirmed = confirm(
        `Delete ${unusedTypes.length} unused gear types?\n\n` +
        unusedTypes.map(t => `- ${t.name}`).join('\n') +
        '\n\nThis cannot be undone!'
      );

      if (!confirmed) return;

      try {
        log(`Deleting ${unusedTypes.length} unused gear types...`, 'info');
        setStatus('Deleting unused gear types...', 'info');

        let deleted = 0;
        for (const type of unusedTypes) {
          await db.collection('gearTypes').doc(type.id).delete();
          log(`Deleted: ${type.name}`, 'success');
          deleted++;
        }

        log(`Successfully deleted ${deleted} gear types!`, 'success');
        setStatus(`Deleted ${deleted} unused gear types`, 'success');

        // Re-analyze
        setTimeout(() => analyzeTypes(), 1000);

      } catch (error) {
        log(`Error deleting: ${error.message}`, 'error');
        setStatus('Delete failed', 'error');
        console.error(error);
      }
    }

    // Auto-analyze on load
    window.addEventListener('load', () => {
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          log(`Signed in as: ${user.email}`, 'success');
          setTimeout(() => analyzeTypes(), 500);
        } else {
          setStatus('Please sign in first', 'error');
          log('Not authenticated. Please sign in.', 'error');
        }
      });
    });
  </script>
</body>
</html>
